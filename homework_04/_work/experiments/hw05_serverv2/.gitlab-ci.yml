image: python:3.8

stages:
  - test

before_script:
  - python --version
  - pip install virtualenv
  - virtualenv venv
  - source venv/bin/activate
  - pip install -r requirements.txt --quiet

# Запуск flake8
flake8:
  stage: test
  before_script:
    - pip install flake8 --quiet
  script:
    - flake8 src/

# Запуск pylint и создание бейджа
pylint:
  stage: test
  before_script:
    - pip install pylint pylint-exit anybadge pylint-gitlab --quiet
  script:
    - mkdir ./public
    - pylint --exit-zero --output-format=text $(find -type f -name "*.py" ! -path "**venv/lib/**") | tee ./public/pylint.log
    - SCORE=$(sed -n 's/^Your code has been rated at \([-0-9.]*\)\/.*/\1/p' ./public/pylint.log)
    - pylint --exit-zero --output-format=pylint_gitlab.GitlabCodeClimateReporter $(find -type f -name "*.py" ! -path "**venv/lib/**") > codeclimate.json
    - pylint --exit-zero --output-format=pylint_gitlab.GitlabPagesHtmlReporter $(find -type f -name "*.py" ! -path "**venv/lib/**") > ./public/index.html
    - anybadge --overwrite --label=Pylint --file=./public/pylint.svg --value=$SCORE 4=red 5=orange 8=yellow 10=green
    - echo "Pylint score is $SCORE"
  artifacts:
    paths:
      - public
    reports:
      codequality: codeclimate.json
    when: always



# Изменение пути кеша pip для хранения его в папке проекта
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Кеш pip не хранит установленные пакеты. Чтобы их кешировать,
# нужно установить их в virtualenv и добавить в кеш папку virtualenv
cache:
  paths:
    - .cache/pip
    - venv/
